- content_for :page_title do
  = t('verification.verification')

- content_for :heading do
  %h2= t('settings.profile')
  = render partial: 'settings/shared/profile_navigation'

- if @truanon_configured
  = simple_form_for @account, url: settings_verification_path, html: { method: :put } do |f|
    = render 'shared/error_messages', object: @account

    %p.lead= t('verification.hint_html')

    %h3= "Verify Using A Privacy-Forward, Portable Identity That Works Across Federated Instances"

    %h4= t('verification.here_is_how')

    %p.lead= "Confirm ownership over public links and profiles, such as blogs and social media. More digital footprints means more confidence."

    %h3= t('verification.turn_on_verified_identity')
    
    .fields-group
      %label
      = f.simple_fields_for :settings, current_user.settings do |ff|
        .fields-group
          .input-copy.lead
            .input-copy__wrapper
            - if @verify_url.present? && @verify_url.length > 0
              %input{ type: :text, maxlength: '999', spellcheck: 'false', readonly: 'true', value: 'Securely Assign Ownership' }
              %button{ type: :button, 'data-url': @verify_url, class: 'btn btn-primary verify-btn' }= 'Verify'
            - else
              %input{ type: :text, maxlength: '999', spellcheck: 'false', readonly: 'true', value: 'Your Account Identity Is Securely Assigned' }
              %button{ type: :button, onclick: "window.open('https://#{@public_profile_url}', '_blank')", class: 'btn btn-primary' }= @public_profile_url

          = ff.input :wants_verified_identity, wrapper: :with_label, hint: t('verification.verified_identity_is_the_single_most_powerful_step_you_can_take_to_amplify_your_profile'), recommended: true

        %h3= t('verification.privacy_settings')

        .fields-group
          %label
          = f.simple_fields_for :settings, current_user.settings do |ff|
            .fields-group
              = ff.input :display_your_public_identity_profile, wrapper: :with_label, hint: t('verification.privacy_is_your_choice;_knowing_your_rank_and_score_makes_you_visibly_trusted')
              = ff.input :display_social_properties, wrapper: :with_label, hint: t('verification.showcase_public_links_and_properties_for_others_to_see_and_share')
            .fields-group
              = ff.input :display_verified_contact_information, wrapper: :with_label
            .fields-group
            .nested-fields-group
              = ff.input :display_basic_profile_details, wrapper: :with_label
              .fields-group-indent
                = ff.input :omit_age, wrapper: :with_label, hint: t('verification.do_not_show_age_related_information')
                = ff.input :omit_pronouns, wrapper: :with_label, hint: t('verification.do_not_display_gender_pronouns')
                = ff.input :omit_location, wrapper: :with_label, hint: t('verification.do_not_display_geographic_details')

    %hr.spacer/

    %h3= t('verification.verify_using_manual_process')

    %h4= t('verification.here_is_how')

    %p.lead= t('verification.instructions_html')

    .input-copy.lead
      .input-copy__wrapper
        %input{ type: :text, maxlength: '999', spellcheck: 'false', readonly: 'true', value: link_to('Mastodon', ActivityPub::TagManager.instance.url_for(@account), rel: 'me').to_str }
      %button{ type: :button }= t('generic.copy')

    %p.lead= t('verification.extra_instructions_html')

    - if @verified_links.any?
      %h4= t('verification.verified_links')
      %ul.lead
        - @verified_links.each do |field|
          %li
            .verified-badge
              = fa_icon 'check', class: 'verified-badge__mark'
              %span= field.value

    .actions
      %button{ type: :submit, class: 'button' }
        = t('generic.save_changes')

  :javascript
    document.addEventListener('DOMContentLoaded', function() {
      document.addEventListener('click', function(e) {
        var target = e.target;
        if (target.classList.contains('verify-btn')) {
          e.preventDefault();
          var url = target.dataset.url;
          var left = (window.innerWidth)- (480 / 2);
          var top = (window.innerHeight / 2) - (820 / 2);
          var win = window.open(url, "ta-popup", "width=480, height=820, top=" + top + ", left=" + left);
          var timer = setInterval(function() {
            if (win.closed) {
              clearInterval(timer);
              window.location.reload(); //refresh when the window closes
            }
          }, 1000);
        }
      });
    });

- else
  %p.lead= @error_message